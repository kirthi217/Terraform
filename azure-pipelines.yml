trigger:
- main

stages:
- stage: Build
  displayName: Terraform Plan
  jobs:
  - job: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Terraform Installer
      inputs:
        terraformVersion: '1.3.10'

    - task: TerraformTask@5
      displayName: Terraform Init
      inputs:
        provider: azurerm
        command: init
        backendServiceArm: Billing-Subscription(af504235-2f6d-4469-aa25-251f498730fc)
        backendAzureRmStorageAccountName: azdevopsvenkat
        backendAzureRmContainerName: terraform
        backendAzureRmKey: terraform.tfstate

    - task: TerraformTask@5
      displayName: Terraform Plan
      inputs:
        provider: azurerm
        command: plan
        commandOptions: -out=tfplan
        environmentServiceNameAzureRM: Billing-Subscription(af504235-2f6d-4469-aa25-251f498730fc)

    # Publish plan and lock file
    - publish: tfplan
      artifact: tfplan
    - publish: .terraform.lock.hcl
      artifact: terraform-lock
      
- stage: Release
  displayName: Terraform Apply
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Apply
    displayName: Apply to Azure
    environment: prod   # Approval gate here
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          # Install Terraform
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: '1.3.10'

          # Download artifacts from Build stage
          - download: current
            artifact: tfplan
          - download: current
            artifact: terraform-lock

          # Copy lock file
          - script: cp $(Pipeline.Workspace)/terraform-lock/.terraform.lock.hcl ./
            displayName: Copy lock file

          # Init (required for provider consistency)
          - task: TerraformTask@5
            displayName: Terraform Init
            inputs:
              provider: azurerm
              command: init
              backendServiceArm: Billing-Subscription(af504235-2f6d-4469-aa25-251f498730fc)
              backendAzureRmStorageAccountName: azdevopsvenkat
              backendAzureRmContainerName: terraform
              backendAzureRmKey: terraform.tfstate

          # Apply saved plan
          - task: TerraformTask@5
            displayName: Terraform Apply
            inputs:
              provider: azurerm
              command: apply
              commandOptions: '$(Pipeline.Workspace)/tfplan/tfplan'
              environmentServiceNameAzureRM: Billing-Subscription(af504235-2f6d-4469-aa25-251f498730fc)
